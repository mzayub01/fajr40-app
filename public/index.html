<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Fajr 40 Challenge</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    * {
      box-sizing: border-box;
    }

  body {
  margin: 0;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  background: #f5f5f5;
  color: #111827;
  overflow-x: hidden; /* prevent whole page from scrolling sideways */
}

    header {
      background: linear-gradient(135deg, #0f766e, #14b8a6);
      color: white;
      padding: 1.5rem;
      text-align: center;
    }

    header h1 {
      margin: 0;
      font-size: 1.6rem;
    }

    header p {
      margin: 0.3rem 0 0;
      font-size: 0.9rem;
    }

    .tagline {
      font-size: 0.8rem;
      color: #e0f2f1;
      margin-top: 0.35rem;
    }

    .sponsor-banner {
      margin-top: 0.75rem;
      font-size: 0.85rem;
      background: rgba(15, 23, 42, 0.25);
      padding: 0.4rem 0.75rem;
      border-radius: 999px;
      display: inline-block;
    }

    main {
      max-width: 1100px;
      margin: 1rem auto 2rem;
      padding: 0 1rem;
    }

    section {
      background: white;
      border-radius: 0.75rem;
      padding: 1rem 1.2rem;
      margin-bottom: 1rem;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
    }

    h2, h3 {
      margin-top: 0;
      font-size: 1.2rem;
    }

    form {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
    }

    .form-group {
      flex: 1 1 220px;
      min-width: 0;
    }

    label {
      display: block;
      font-size: 0.9rem;
      margin-bottom: 0.25rem;
    }

    input,
    select,
    button {
      width: 100%;
      padding: 0.55rem 0.6rem;
      font-size: 0.95rem;
      border-radius: 0.5rem;
      border: 1px solid #d4d4d4;
    }

    input:focus,
    select:focus {
      outline: none;
      border-color: #0f766e;
      box-shadow: 0 0 0 1px rgba(15, 118, 110, 0.2);
    }

    button {
      background: #0f766e;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 600;
    }

    button:hover {
      background: #115e59;
    }

    .btn-secondary {
      background: #e5e7eb;
      color: #111827;
    }

    .btn-secondary:hover {
      background: #d1d5db;
    }
/* Highlight the Fajr check-in button in orange */
#checkin-btn {
  background: #f97316;      /* orange */
  color: white;
}

#checkin-btn:hover {
  background: #ea580c;      /* slightly darker orange */
}

    .two-column {
      display: grid;
      grid-template-columns: 1.1fr 1.1fr;
      gap: 1rem;
    }

    .message {
      margin-top: 0.5rem;
      font-size: 0.9rem;
    }

    .message.success {
      color: #16a34a;
    }

    .message.error {
      color: #b91c1c;
    }

    .leaderboard-tables {
      display: grid;
      gap: 0.75rem;
    }

.leaderboard-table-wrapper {
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
  max-width: 100%;
}

/* Tables will be at least 650px wide so they scroll inside the wrapper,
   but the wrapper itself never makes the whole page scroll */
.leaderboard-table-wrapper table {
  width: 100%;
  min

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }

    th, td {
      padding: 0.4rem 0.5rem;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
      white-space: nowrap;
    }

    th {
      background: #f3f4f6;
      font-weight: 600;
    }

    /* Make any table images small & circular */
    td img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
    }

    .checkin-photo-preview {
      margin-top: 0.5rem;
      max-width: 150px;
      border-radius: 0.5rem;
    }

    .admin-warning {
      font-size: 0.8rem;
      color: #b91c1c;
      margin-top: 0.5rem;
    }

    /* Hide admin section by default; JS shows it for admins */
    #admin-section {
      display: none;
    }

    @media (max-width: 900px) {
      .two-column {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 640px) {
      header h1 {
        font-size: 1.35rem;
      }

      header p {
        font-size: 0.85rem;
      }

      main {
        padding: 0 0.75rem;
      }

      form {
        flex-direction: column;
      }

      .form-group {
        flex: 1 1 100%;
      }

      section {
        padding: 0.9rem 0.9rem;
      }

      button {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Fajr 40 Challenge</h1>
    <p>Inspiring young hearts to stand for Fajr in the masjid for 40 days, inshaAllah.</p>
    <p class="tagline">Parents register on behalf of children. Track their streak, celebrate their effort, and earn rewards.</p>
    <div class="sponsor-banner">
      Local business? <strong>Sponsor the Fajr 40 Challenge</strong> and donate prizes for children who complete it.
    </div>
  </header>

  <main>
    <!-- Auth & basic actions -->
    <section id="auth-section">
      <h2>Register &amp; Login</h2>
      <div class="two-column">
        <!-- Registration -->
        <div>
          <h3>Parent Registration</h3>
          <form id="register-form">
            <div class="form-group">
              <label for="parentName">Parent Name</label>
              <input type="text" id="parentName" required />
            </div>
            <div class="form-group">
              <label for="childName">Child Name</label>
              <input type="text" id="childName" required />
            </div>
            <div class="form-group">
              <label for="email">Parent Email</label>
              <input type="email" id="email" required />
            </div>
            <div class="form-group">
              <label for="city">City</label>
              <input type="text" id="city" required />
            </div>
            <div class="form-group">
              <label for="masjid">Masjid</label>
              <input type="text" id="masjid" required />
            </div>
            <div class="form-group">
              <label for="age">Child Age (3–17)</label>
              <input type="number" id="age" min="3" max="17" required />
            </div>
            <div class="form-group">
              <label for="password">Password</label>
              <input type="password" id="password" required />
            </div>
            <div class="form-group">
              <button type="submit">Register</button>
            </div>
          </form>
          <div id="register-message" class="message"></div>
        </div>

        <!-- Login -->
        <div>
          <h3>Login</h3>
          <form id="login-form">
            <div class="form-group">
              <label for="loginEmail">Parent Email</label>
              <input type="email" id="loginEmail" required />
            </div>
            <div class="form-group">
              <label for="loginPassword">Password</label>
              <input type="password" id="loginPassword" required />
            </div>
            <div class="form-group">
              <button type="submit">Login</button>
            </div>
          </form>
          <div id="login-message" class="message"></div>
        </div>
      </div>
    </section>

    <!-- Logged-in dashboard -->
    <section id="dashboard-section" style="display:none;">
      <h2>My Child's Fajr Progress</h2>
      <p id="welcome-text"></p>
      <p id="streak-text"></p>
      <p id="extra-stats"></p>

      <h3>Fajr Check-in</h3>
      <form id="checkin-form" enctype="multipart/form-data">
        <div class="form-group">
          <label for="checkin-photo">Upload Fajr photo (optional but encouraged)</label>
          <input type="file" id="checkin-photo" accept="image/*" />
        </div>
        <div class="form-group">
          <button type="submit" id="checkin-btn">Check-in for today's Fajr</button>
        </div>
      </form>
      <img id="checkin-photo-preview" class="checkin-photo-preview" style="display:none;" />
      <div id="checkin-message" class="message"></div>

      <button id="logout-btn" class="btn-secondary" style="margin-top:0.75rem;">Logout</button>
    </section>

    <!-- Sponsor section -->
    <section id="sponsor-section">
      <h2>Sponsor the Fajr 40 Challenge</h2>
      <p style="font-size:0.9rem;">
        Local businesses and individuals can sponsor prizes for children who complete 40 consecutive days of Fajr in the masjid.
        Your sponsorship will be reviewed by the admin team inshaAllah.
      </p>
      <form id="sponsor-form">
        <div class="form-group">
          <label for="sponsorName">Business / Sponsor Name</label>
          <input type="text" id="sponsorName" required />
        </div>
        <div class="form-group">
          <label for="sponsorEmail">Contact Email</label>
          <input type="email" id="sponsorEmail" required />
        </div>
        <div class="form-group">
          <label for="sponsorPhone">Contact Phone</label>
          <input type="text" id="sponsorPhone" />
        </div>
        <div class="form-group">
          <label for="sponsorPrize">Prize details (e.g. voucher, gift, experience)</label>
          <input type="text" id="sponsorPrize" required />
        </div>
        <div class="form-group">
          <button type="submit">Submit Sponsorship Offer</button>
        </div>
      </form>
      <div id="sponsor-message" class="message"></div>
    </section>

    <!-- Leaderboards -->
    <section id="leaderboard-section">
      <h2>Leaderboards</h2>
      <p style="font-size:0.9rem;">Names below refer to children (not parents). Only city and masjid are shown here; parent contact details remain private.</p>

      <div class="leaderboard-tables">
        <!-- Global leaderboard -->
        <div>
          <h3>Global Leaderboard</h3>
          <div class="leaderboard-table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>#</th>
                  <th>Child</th>
                  <th>City</th>
                  <th>Masjid</th>
                  <th>Current Streak</th>
                  <th>Best Streak</th>
                  <th>40-day Completions</th>
                </tr>
              </thead>
              <tbody id="global-leaderboard-body">
                <!-- Populated by JS -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- Masjid leaderboard -->
        <div>
          <h3>Masjid Leaderboard</h3>
          <div class="form-group" style="max-width:250px;margin-bottom:0.5rem;">
            <label for="masjidFilter">Filter by Masjid</label>
            <input type="text" id="masjidFilter" placeholder="Enter masjid name" />
          </div>
          <div class="leaderboard-table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>#</th>
                  <th>Child</th>
                  <th>Masjid</th>
                  <th>City</th>
                  <th>Current Streak</th>
                  <th>Best Streak</th>
                  <th>40-day Completions</th>
                </tr>
              </thead>
              <tbody id="masjid-leaderboard-body">
                <!-- Populated by JS -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- Age group leaderboard -->
        <div>
          <h3>Age Group Leaderboard</h3>
          <div class="leaderboard-table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>Age Group</th>
                  <th>Total Participants</th>
                  <th>Avg Current Streak</th>
                  <th>Total 40-day Completions</th>
                </tr>
              </thead>
              <tbody id="age-leaderboard-body">
                <!-- Populated by JS -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- Admin section (hidden by default) -->
    <section id="admin-section">
      <h2>Admin Dashboard</h2>
      <p class="admin-warning">
        Admin access only. Parent and child personal details shown here must be handled securely and kept private.
      </p>

      <!-- Participants -->
      <h3>Participants</h3>
      <div class="leaderboard-table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Child</th>
              <th>Age</th>
              <th>City</th>
              <th>Masjid</th>
              <th>Parent Name</th>
              <th>Parent Email</th>
              <th>Current Streak</th>
              <th>Best Streak</th>
              <th>40-day Completions</th>
            </tr>
          </thead>
          <tbody id="admin-participants-body">
            <!-- Populated by JS -->
          </tbody>
        </table>
      </div>

      <!-- Sponsors -->
      <h3>Sponsored Prizes</h3>
      <div class="leaderboard-table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Business</th>
              <th>Email</th>
              <th>Phone</th>
              <th>Prize</th>
              <th>Approved</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="admin-sponsors-body">
            <!-- Populated by JS -->
          </tbody>
        </table>
      </div>

      <!-- Check-in photos -->
      <h3>Recent Check-in Photos</h3>
      <div class="leaderboard-table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Child</th>
              <th>Masjid</th>
              <th>City</th>
              <th>Photo</th>
            </tr>
          </thead>
          <tbody id="admin-photos-body">
            <!-- Populated by JS -->
          </tbody>
        </table>
      </div>

      <button id="export-completions-btn" style="margin-top:0.75rem;">Export 40-Day Completers (CSV)</button>
      <div id="admin-message" class="message"></div>
    </section>
  </main>

  <script>
    const registerForm = document.getElementById("register-form");
    const loginForm = document.getElementById("login-form");
    const checkinForm = document.getElementById("checkin-form");
    const sponsorForm = document.getElementById("sponsor-form");

    const registerMessage = document.getElementById("register-message");
    const loginMessage = document.getElementById("login-message");
    const checkinMessage = document.getElementById("checkin-message");
    const sponsorMessage = document.getElementById("sponsor-message");
    const adminMessage = document.getElementById("admin-message");

    const dashboardSection = document.getElementById("dashboard-section");
    const authSection = document.getElementById("auth-section");
    const adminSection = document.getElementById("admin-section");

    const welcomeText = document.getElementById("welcome-text");
    const streakText = document.getElementById("streak-text");
    const extraStats = document.getElementById("extra-stats");
    const logoutBtn = document.getElementById("logout-btn");

    const checkinPhotoInput = document.getElementById("checkin-photo");
    const checkinPhotoPreview = document.getElementById("checkin-photo-preview");

    const globalLeaderboardBody = document.getElementById("global-leaderboard-body");
    const masjidLeaderboardBody = document.getElementById("masjid-leaderboard-body");
    const ageLeaderboardBody = document.getElementById("age-leaderboard-body");
    const masjidFilterInput = document.getElementById("masjidFilter");

    const adminParticipantsBody = document.getElementById("admin-participants-body");
    const adminSponsorsBody = document.getElementById("admin-sponsors-body");
    const adminPhotosBody = document.getElementById("admin-photos-body");
    const exportCompletionsBtn = document.getElementById("export-completions-btn");

    let fullLeaderboardCache = [];

    const API_HEADERS = () => {
      const token = localStorage.getItem("token");
      return token
        ? { Authorization: "Bearer " + token }
        : {};
    };

    function setMessage(el, text, type) {
      if (!el) return;
      el.textContent = text;
      el.className = "message " + (type || "");
    }

    function logout() {
      localStorage.removeItem("token");
      localStorage.removeItem("isAdmin");
      authSection.style.display = "block";
      dashboardSection.style.display = "none";
      if (adminSection) adminSection.style.display = "none";
    }

    logoutBtn.addEventListener("click", () => {
      logout();
    });

    // Preview photo on selection
    if (checkinPhotoInput) {
      checkinPhotoInput.addEventListener("change", () => {
        const file = checkinPhotoInput.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = e => {
            checkinPhotoPreview.src = e.target.result;
            checkinPhotoPreview.style.display = "block";
          };
          reader.readAsDataURL(file);
        } else {
          checkinPhotoPreview.style.display = "none";
        }
      });
    }

    // Registration
    registerForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      setMessage(registerMessage, "", "");

      const parentName = document.getElementById("parentName").value.trim();
      const childName = document.getElementById("childName").value.trim();
      const email = document.getElementById("email").value.trim();
      const city = document.getElementById("city").value.trim();
      const masjid = document.getElementById("masjid").value.trim();
      const age = parseInt(document.getElementById("age").value, 10);
      const password = document.getElementById("password").value;

      if (age < 3 || age > 17) {
        setMessage(registerMessage, "Child age must be between 3 and 17.", "error");
        return;
      }

      try {
        const res = await fetch("/api/register", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ parentName, childName, email, city, masjid, age, password })
        });

        const data = await res.json();
        if (!res.ok) {
          setMessage(registerMessage, data.error || "Registration failed.", "error");
        } else {
          setMessage(registerMessage, "Registered successfully. You can now log in.", "success");
          registerForm.reset();
        }
      } catch (err) {
        console.error(err);
        setMessage(registerMessage, "An error occurred. Please try again.", "error");
      }
    });

    // Fetch profile (/api/me) and update dashboard + admin visibility
    async function loadProfile() {
      const headers = API_HEADERS();
      if (!headers.Authorization) return null;

      try {
        const res = await fetch("/api/me", { headers });
        if (!res.ok) {
          return null;
        }
        const user = await res.json();

        // Save isAdmin for later
        localStorage.setItem("isAdmin", user.isAdmin ? "true" : "false");

        // Show dashboard
        authSection.style.display = "none";
        dashboardSection.style.display = "block";

        // Fill texts
        const childName = user.name || "your child";
        const ageText = user.age ? ` (age ${user.age})` : "";
        const city = user.city || "";
        const masjid = user.masjid || "";

        welcomeText.textContent =
          `Logged in as parent of ${childName}${ageText}` +
          `${city || masjid ? " – " : ""}` +
          `${city}${city && masjid ? " · " : ""}${masjid}`;

        streakText.textContent = `Current streak: ${user.currentStreak ?? 0} days`;
        extraStats.textContent =
          `Best streak: ${user.bestStreak ?? 0} · 40-day completions: ${user.completionsCount ?? 0}`;

        // Admin?
        if (user.isAdmin && adminSection) {
          adminSection.style.display = "block";
          await loadAdminData();
        } else if (adminSection) {
          adminSection.style.display = "none";
        }

        return user;
      } catch (err) {
        console.error("Error loading profile:", err);
        return null;
      }
    }

    // Login
    loginForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      setMessage(loginMessage, "", "");

      const email = document.getElementById("loginEmail").value.trim();
      const password = document.getElementById("loginPassword").value;

      try {
        const res = await fetch("/api/login", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ email, password })
        });

        const data = await res.json();
        if (!res.ok || !data.token || !data.user) {
          setMessage(loginMessage, data.error || "Invalid credentials.", "error");
          return;
        }

        // Store token
        localStorage.setItem("token", data.token);

        // Immediately load profile & stats
        await loadProfile();

        // After login, load leaderboards
        await loadLeaderboards();

        setMessage(loginMessage, "Login successful.", "success");
      } catch (err) {
        console.error(err);
        setMessage(loginMessage, "An error occurred. Please try again.", "error");
      }
    });

    // Check-in (with or without photo)
    checkinForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      setMessage(checkinMessage, "", "");

      const token = localStorage.getItem("token");
      if (!token) {
        setMessage(checkinMessage, "Please log in first.", "error");
        return;
      }

      const file = checkinPhotoInput.files[0];
      let res, data;

      try {
        if (file) {
          // Use photo endpoint
          const formData = new FormData();
          formData.append("photo", file);

          res = await fetch("/api/checkin-photo", {
            method: "POST",
            headers: {
              Authorization: "Bearer " + token
            },
            body: formData
          });
        } else {
          // Use normal checkin (no photo)
          res = await fetch("/api/checkin", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: "Bearer " + token
            },
            body: JSON.stringify({})
          });
        }

        data = await res.json();
        if (!res.ok) {
          setMessage(checkinMessage, data.error || "Check-in failed.", "error");
          return;
        }

        setMessage(checkinMessage, data.message || "Fajr check-in recorded! MashaAllah.", "success");

        // Reload profile so streaks are accurate
        await loadProfile();

        // Refresh leaderboards & admin view
        await loadLeaderboards();
        if (localStorage.getItem("isAdmin") === "true") {
          await loadAdminData();
        }
      } catch (err) {
        console.error(err);
        setMessage(checkinMessage, "An error occurred. Please try again.", "error");
      }
    });

    // Sponsor form
    sponsorForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      setMessage(sponsorMessage, "", "");

      const sponsorName = document.getElementById("sponsorName").value.trim();
      const sponsorEmail = document.getElementById("sponsorEmail").value.trim();
      const sponsorPhone = document.getElementById("sponsorPhone").value.trim();
      const sponsorPrize = document.getElementById("sponsorPrize").value.trim();

      const businessName = sponsorName;
      const contactEmail = sponsorEmail;
      const contactPhone = sponsorPhone || null;
      const prizeDescription = sponsorPrize;

      try {
        const res = await fetch("/api/sponsors", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ businessName, contactEmail, contactPhone, prizeDescription })
        });

        const data = await res.json();
        if (!res.ok) {
          setMessage(sponsorMessage, data.error || "Failed to submit sponsorship.", "error");
          return;
        }

        setMessage(sponsorMessage, "JazakAllahu khayran! Your sponsorship offer has been submitted for review.", "success");
        sponsorForm.reset();
      } catch (err) {
        console.error(err);
        setMessage(sponsorMessage, "An error occurred. Please try again.", "error");
      }
    });

    // Load leaderboards using /api/leaderboard and /api/leaderboard-full
    async function loadLeaderboards() {
      try {
        // Global (top 100)
        const globalRes = await fetch("/api/leaderboard");
        const globalData = await globalRes.json();
        globalLeaderboardBody.innerHTML = "";
        (globalData || []).forEach((row, idx) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${idx + 1}</td>
            <td>${row.name || ""}</td>
            <td>${row.city || ""}</td>
            <td>${row.masjid || ""}</td>
            <td>${row.currentStreak ?? 0}</td>
            <td>${row.bestStreak ?? 0}</td>
            <td>${row.completionsCount ?? 0}</td>
          `;
          globalLeaderboardBody.appendChild(tr);
        });

        // Full data for masjid + age grouping
        const fullRes = await fetch("/api/leaderboard-full");
        fullLeaderboardCache = await fullRes.json() || [];
        renderMasjidLeaderboard();
        renderAgeLeaderboard();

      } catch (err) {
        console.error("Error loading leaderboards:", err);
      }
    }

    function renderMasjidLeaderboard() {
      const filter = masjidFilterInput.value.trim().toLowerCase();
      masjidLeaderboardBody.innerHTML = "";

      const data = (fullLeaderboardCache || [])
        .filter(row => !filter || (row.masjid || "").toLowerCase().includes(filter))
        .sort((a, b) => {
          // Sort: completions desc, currentStreak desc, bestStreak desc
          if ((b.completionsCount ?? 0) !== (a.completionsCount ?? 0)) {
            return (b.completionsCount ?? 0) - (a.completionsCount ?? 0);
          }
          if ((b.currentStreak ?? 0) !== (a.currentStreak ?? 0)) {
            return (b.currentStreak ?? 0) - (a.currentStreak ?? 0);
          }
          return (b.bestStreak ?? 0) - (a.bestStreak ?? 0);
        });

      data.forEach((row, idx) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${idx + 1}</td>
          <td>${row.name || ""}</td>
          <td>${row.masjid || ""}</td>
          <td>${row.city || ""}</td>
          <td>${row.currentStreak ?? 0}</td>
          <td>${row.bestStreak ?? 0}</td>
          <td>${row.completionsCount ?? 0}</td>
        `;
        masjidLeaderboardBody.appendChild(tr);
      });
    }

    masjidFilterInput.addEventListener("input", () => {
      renderMasjidLeaderboard();
    });

    function renderAgeLeaderboard() {
      ageLeaderboardBody.innerHTML = "";
      if (!fullLeaderboardCache || fullLeaderboardCache.length === 0) return;

      const groups = [
        { label: "3–6", min: 3, max: 6 },
        { label: "7–10", min: 7, max: 10 },
        { label: "11–14", min: 11, max: 14 },
        { label: "15–17", min: 15, max: 17 },
      ];

      groups.forEach(group => {
        const members = fullLeaderboardCache.filter(u =>
          typeof u.age === "number" &&
          u.age >= group.min &&
          u.age <= group.max
        );
        const totalParticipants = members.length;
        const avgStreak = totalParticipants
          ? Math.round(
              members.reduce((sum, u) => sum + (u.currentStreak ?? 0), 0) /
              totalParticipants
            )
          : 0;
        const completions = members.reduce((sum, u) => sum + (u.completionsCount ?? 0), 0);

        if (totalParticipants === 0 && completions === 0) return;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${group.label}</td>
          <td>${totalParticipants}</td>
          <td>${avgStreak}</td>
          <td>${completions}</td>
        `;
        ageLeaderboardBody.appendChild(tr);
      });
    }

    // Admin data
    async function loadAdminData() {
      const headers = API_HEADERS();
      if (!headers.Authorization) return;

      try {
        // Participants
        const pRes = await fetch("/api/admin/users", { headers });
        const participants = await pRes.json();
        adminParticipantsBody.innerHTML = "";
        (participants || []).forEach((p) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${p.name || ""}</td>
            <td>${p.age ?? ""}</td>
            <td>${p.city || ""}</td>
            <td>${p.masjid || ""}</td>
            <td>${p.parentName || ""}</td>
            <td>${p.email || ""}</td>
            <td>${p.currentStreak ?? 0}</td>
            <td>${p.bestStreak ?? 0}</td>
            <td>${p.completionsCount ?? 0}</td>
          `;
          adminParticipantsBody.appendChild(tr);
        });

        // Sponsors
        const sRes = await fetch("/api/admin/sponsors", { headers });
        const sponsors = await sRes.json();
        adminSponsorsBody.innerHTML = "";
        (sponsors || []).forEach((s) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${s.businessName || ""}</td>
            <td>${s.contactEmail || ""}</td>
            <td>${s.contactPhone || ""}</td>
            <td>${s.prizeDescription || ""}</td>
            <td>${s.approved ? "Yes" : "No"}</td>
            <td>
              ${s.approved ? "" : `<button data-id="${s.id}" data-action="approve">Approve</button>`}
            </td>
          `;
          adminSponsorsBody.appendChild(tr);
        });

        // Photos
        const cRes = await fetch("/api/admin/checkin-photos", { headers });
        const photos = await cRes.json();
        adminPhotosBody.innerHTML = "";
        (photos || []).forEach((c) => {
          const tr = document.createElement("tr");
          const imgCell = c.photoFilename
            ? `<img src="/uploads/${c.photoFilename}" alt="Check-in photo" />`
            : "";
          tr.innerHTML = `
            <td>${c.date || ""}</td>
            <td>${c.childName || ""}</td>
            <td>${c.masjid || ""}</td>
            <td>${c.city || ""}</td>
            <td>${imgCell}</td>
          `;
          adminPhotosBody.appendChild(tr);
        });

      } catch (err) {
        console.error("Error loading admin data:", err);
        setMessage(adminMessage, "Error loading admin data.", "error");
      }
    }

    // Admin sponsor action buttons (approve only)
    adminSponsorsBody.addEventListener("click", async (e) => {
      const btn = e.target.closest("button");
      if (!btn) return;

      const id = btn.getAttribute("data-id");
      const action = btn.getAttribute("data-action");
      if (!id || action !== "approve") return;

      const headers = {
        ...API_HEADERS(),
        "Content-Type": "application/json"
      };

      try {
        const res = await fetch(`/api/admin/sponsors/${id}/approve`, {
          method: "POST",
          headers
        });
        const data = await res.json();
        if (!res.ok) {
          setMessage(adminMessage, data.error || "Failed to update sponsor.", "error");
        } else {
          setMessage(adminMessage, "Sponsor approved.", "success");
          loadAdminData();
        }
      } catch (err) {
        console.error(err);
        setMessage(adminMessage, "An error occurred.", "error");
      }
    });

    // Export completions (uses /api/admin/export-completers)
    exportCompletionsBtn.addEventListener("click", async () => {
      const headers = API_HEADERS();
      if (!headers.Authorization) return;

      try {
        const res = await fetch("/api/admin/export-completers", {
          headers
        });
        if (!res.ok) {
          const data = await res.json();
          setMessage(adminMessage, data.error || "Failed to export.", "error");
          return;
        }

        const blob = await res.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "fajr40_completers.csv";
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.URL.revokeObjectURL(url);
        setMessage(adminMessage, "CSV exported.", "success");
      } catch (err) {
        console.error(err);
        setMessage(adminMessage, "An error occurred.", "error");
      }
    });

    // Handle /admin route + restore session
    document.addEventListener("DOMContentLoaded", async () => {
      const token = localStorage.getItem("token");

      if (window.location.pathname === "/admin") {
        if (!token) {
          window.location.href = "/";
          return;
        }
        const user = await loadProfile();
        if (!user || !user.isAdmin) {
          window.location.href = "/";
          return;
        }
        authSection.style.display = "none";
        dashboardSection.style.display = "none";
        adminSection.style.display = "block";
        await loadLeaderboards();
        await loadAdminData();
        adminSection.scrollIntoView({ behavior: "smooth" });
      } else {
        if (token) {
          await loadProfile();
          await loadLeaderboards();
        } else {
          // Not logged in
          authSection.style.display = "block";
          dashboardSection.style.display = "none";
          if (adminSection) adminSection.style.display = "none";
          await loadLeaderboards();
        }
      }
    });
  </script>
</body>
</html>
